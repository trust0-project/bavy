#!/usr/bin/expect -f

set timeout 120

# Strip ANSI codes for better matching
log_user 1

# Start the VM
spawn cargo run -p riscv-vm --release -- --kernel target/riscv64gc-unknown-none-elf/release/kernel --disk target/riscv64gc-unknown-none-elf/release/fs.img --harts 4

# Wait for boot prompt (handle ANSI escape codes)
expect {
    -re "Bavy.*#" {
        puts "\n>>> VM booted successfully, prompt detected"
    }
    "BOOT COMPLETE" {
        # Wait a bit more for the prompt
        sleep 2
        puts "\n>>> Boot complete message seen, waiting for prompt..."
    }
    timeout {
        puts "\n>>> TIMEOUT waiting for boot"
        exit 1
    }
}

# Wait a bit more to ensure we're at the prompt
sleep 2

# Record the time we got the prompt
set boot_time [clock seconds]
puts ">>> Boot complete at timestamp: $boot_time"

# Wait 25 seconds to let the system stabilize and potentially trigger the hang
puts ">>> Waiting 25 seconds..."
sleep 25

set after_wait [clock seconds]
puts ">>> After waiting, timestamp: $after_wait"
puts ">>> Now attempting to run 'ls' command..."

# Try to send ls command
send "ls\r"

# Wait for response with a shorter timeout to detect hang
set timeout 30
expect {
    -re "etc/|home/|usr/|var/" {
        puts "\n>>> SUCCESS: 'ls' command worked! Output received."
    }
    -re "Bavy.*#" {
        puts "\n>>> Got prompt back after ls"
    }
    timeout {
        puts "\n>>> HANG DETECTED: No response to 'ls' command after 30 second timeout!"
        exit 2
    }
}

# Try ps to see process state
puts ">>> Running 'ps' to check process state..."
send "ps\r"

expect {
    -re "PID.*STATE|klogd|sysmond" {
        puts "\n>>> 'ps' command working"
    }
    timeout {
        puts "\n>>> HANG DETECTED on 'ps' command!"
        exit 2
    }
}

# Let it run a few more seconds to capture full output
sleep 3

puts "\n>>> Test completed - VM appears to be working!"
send "\x03"
sleep 1

expect eof
