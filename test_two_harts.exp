#!/usr/bin/expect -f

set timeout 60

# Start the VM with 2 harts (klogd runs, sysmond doesn't)
spawn cargo run -p riscv-vm --release -- --kernel target/riscv64gc-unknown-none-elf/release/kernel --disk target/riscv64gc-unknown-none-elf/release/fs.img --harts 2

# Wait for boot
expect {
    "BOOT COMPLETE" {
        puts "\n>>> Boot complete"
    }
    timeout {
        puts "\n>>> TIMEOUT waiting for boot"
        exit 1
    }
}

sleep 3
puts ">>> Waiting 30 seconds..."
sleep 30

# Test ps command
puts ">>> Testing 'ps' command with 2 harts..."
send "ps\r"

expect {
    -re "klogd" {
        puts "\n>>> 'ps' showed klogd - WORKING!"
    }
    -re "PID.*STATE" {
        puts "\n>>> 'ps' header seen!"
    }
    -re "Bavy.*#" {
        puts "\n>>> Got prompt"
    }
    timeout {
        puts "\n>>> TIMEOUT on 'ps' with 2 harts!"
        exit 2
    }
}

sleep 2

# Test again
puts ">>> Testing 'ls' command..."
send "ls\r"

expect {
    -re "etc/|var/|usr/" {
        puts "\n>>> 'ls' works!"
    }
    -re "Bavy.*#" {
        puts "\n>>> Got prompt after ls"
    }
    timeout {
        puts "\n>>> TIMEOUT on 'ls'!"
        exit 3
    }
}

puts "\n>>> 2-hart test completed"
send "\x03"
sleep 1
expect eof

